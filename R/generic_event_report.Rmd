---
output:
  html_document:
    toc: true
    toc_depth: 2
params:
  owner: NULL
  event: NULL
  utility: NULL
title: "`r paste(params$event$name, "impact report for <br>", params$owner$owner)`"
author: "`r paste("by kWIQly on behalf of ", params$owner$intermediary)`"
---

***


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning = FALSE) # 

sql = paste("WITH m AS (SELECT poi_id as poid, update_status, mid::text as mid, utility, intermediary_id as iid, trim(mpr::text) as mpr FROM v1.poi_meters),",
             "p AS (SELECT id as poid, owner_id as oid, postcode, location_id::text, latitude, longitude FROM v1.poi),",
             "o AS (SELECT id as oid, owner, match_ref FROM v1.owner),",
             "i AS (SELECT id as iid, intermediary FROM v1.intermediary)",
             "SELECT m.*, p.postcode, p.location_id, p.latitude, p.longitude, i.intermediary, o.oid, o.owner, o.match_ref FROM m, p, o, i",
             "WHERE  m.iid = i.iid AND m.poid = p.poid AND o.oid = p.oid AND o.oid = ?oid and m.utility = ?utility")

meter_meta <-  q(sql, oid = oid, utility = utility)


owner_utility_meter_days <- q("SELECT mid::text as mid, mpr, unnest(ts) as ts, unnest(oat)/1000 as oat, unnest(watts)/100 as kw, unnest(fit)/1000 as expected FROM v1.poi_meters pm, v1.poi p WHERE pm.poi_id = p.id AND p.owner_id = ?oid and pm.utility = ?utility;", oid = oid, utility = utility) %>%
    mutate(dow = factor(
      weekdays(ts),
      levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")
    ))


meter_events <- owner_utility_meter_days %>% 
  filter(ts >= e$start_date, ts <= e$end_date) %>% 
  group_by(mid) %>% 
  arrange(desc(ts)) %>% 
  summarise(mpr = first(mpr), 
            expected = mean(expected, na.rm = TRUE), 
            actual = mean(kw, na.rm = TRUE), .groups = 'drop') %>%
      mutate(turndown = round(100 * actual / expected,1), recent_zero = sum(cumsum(actual)==0))
  


owner_data <- meter_meta %>% group_by(owner, intermediary) %>%
    summarise(n= n(),.groups = 'drop')


event_name <- paste(e$name, "From", e$start_date, "~",ifelse(is.na(e$end_date), "Ongoing", e$end_date) )

ou_consolidation <- owner_utility_meter_days %>% select(-mid, -mpr) %>% 
  mutate(waste = kw - expected, abs_e = abs(waste), p_e = waste * (waste > 0), n_e  = waste * (waste < 0), n = 1) %>% group_by(dow, ts, .drop = ts) %>% 
  summarise_if(is.numeric, sum, na.rm=TRUE)


filter_history_by_period <- function(ouc, period){
  today <- max(ouc$ts)
  ys <- as.Date(paste(format(Sys.Date(), "%Y"), "01-01", sep = "-"))
  rms <- floor_date(today - months(1), "month")
  rmq <- floor_date(today - months(3), "month")
  tr <- switch(period,
               "1"={c(ys  , today)}, # YTD
               "2"={c(today - 366  , today)}, # RY
               "3"={c(rmq  , today)}, # RQ
               "4"={c(rms  , today)}, # RM
               "5"={c(today - 6  , today)}, # RW
               "6"={c(as.Date("2000-01-01")  , today)}) # ALL

  ouc %>% filter(ts >= tr[1], ts <= tr[2])
}

ou_consolidation <- filter_history_by_period(ou_consolidation, "2")

ou_time_selected <- ou_consolidation %>% 
  filter(ts >= e$start_date, ts <= e$end_date)
    

event_start = e$start_date
event_end = e$end_date
owner_name = owner_data$owner
ae_dist_chart = ae_dist_chart(meter_events)
a_vs_e_chart = a_vs_e_chart(meter_events, NULL)
ouehp = high_low_forecast_errors(ou_time_selected) %>% maybe_show_event(e)
ecic = event_context_impact_chart(ou_consolidation) %>% maybe_show_event(e)
ouhp = event_impact_chart(ou_time_selected) %>% maybe_show_event(e)
oucp = cumulative_waste_impact_chart(ou_time_selected) %>% maybe_show_event(e)
ouoat = selected_period_oat_chart(ou_consolidation, ou_time_selected)

  
  #  css: style.css
```


## Summary of Impact

Depending on the business of your organisation, consumption of some meters may increase, some may be relatively unaffected, whilst others may fall. 

For example, some individual supermarkets legitimately see increased consumption as do many residential properties, whilst others and especially hotels, restaurants, pubs and universities see dramatic decreases.

In short, the report is objective and should be considered within context. What it will do at least is highlight which meters are performing relatively and absolutely better than others.

Note: Total meters considered are limited to the definition provided to us and those having a clear performance history. 

```{r summary}
kWh_kg_CO2g_UK <- function(x)
  paste0(format(round(x*0.185),big.mark   = ","), " kg.CO2g")

x = meter_events %>% mutate(change = ifelse(turndown >100, 1, -1)) %>%
  summarise(meters = n(),
            increased = sum(change>0,na.rm=TRUE),
            decreased = sum(change<0,na.rm=TRUE),
            actual =  round(sum(actual,na.rm=TRUE),1),
            expected =  round(sum(expected,na.rm=TRUE),1),
            weighted_average = round(100 * actual / expected, 1),
            median_turndown = round(median(turndown,na.rm=TRUE),1),
            co2 = kWh_kg_CO2g_UK((actual - expected) * 1000)
            )

colnames(x) <- c("# Meters", "# Increased", "# Decreased", "Actual Total (MWh)", "Expected Total (MWh)", "Median Turndown to %", "Weighted Turndown %", "CO2g kg")

  kable(x,format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 11, fixed_thead = T)
```


## Timeline of Impact

A simple time chart illustrates the total  `r owner_name` impact relative to normal for the day of week and weather conditions since the event started on `r event_start` (as indicated in green).

```{r ouhp, echo=FALSE, out.height="100%", out.width="90%"}
ouhp
```


```{r ouoat, echo=FALSE, out.height="100%", out.width="90%"}
ouoat
```

```{r ecic, echo=FALSE, out.height="100%", out.width="90%"}
ecic
```


## Range of responses

The following chart shows a distribution of responses, it is naturally more meaningful given large numbers of meters. Simplistically meters to the left of 100% have reduced energy consumption in contrast with seasonally normalised expectations.

Note: If there are any meters where consumption has increased by over two-fold these will be shown on the extreme right side of the chart.  Complete values are recorded in the detail table below, which can be exported to .csv or spreadsheet.

```{r dist, echo=FALSE, out.height="100%", out.width="90%"}
ae_dist_chart
```


## Response to event by individual meters

A simple plot of each meter (where adequate data exists) indicates whether consumption in the period has risen or fallen relative to expected consumption. Those with reduced consumption lie within the green area. Depending on your results distribution it may be necessary to zoom by dragging and/or double-clicking to reset.  

Meters with typically lower consumption are on the left, and more significant consumption on the right.

Scope for savings is indicated by the vertical position - shown by the second number of the tooltip that is shown on 'hover'.

By hovering on high purple markers the relatively poor performing meters can be identified.

Interactive versions of analysis allow meter detail to be explored by clicking to drill down.

```{r a_vs_e, echo=FALSE, out.height="100%", out.width="90%"}
print(a_vs_e_chart)
```

## Impact by day of week

The impact will not typically be the same for each day of the week. So cumulative costs or savings relative to automated budgets can be seen to diverge.  This is simply because on days of lower consumption (often weekends in workplaces or Tuesdays in retail spaces) - there is less scope for consumption to fall.


```{r oucp, echo=FALSE, out.height="100%", out.width="90%"}
print(oucp)
```

## Typical impacts

Unexpected deviations relative to normal, for time of week given weather, take place continually. Typically around half of meters will be higher than normal and half will be lower. Meters with high errors (indicating over-consumption) and low errors (indicating under-consumption) are counted and displayed over time. 

During a 'global' event (i.e. one effecting all meters in the same sense) many errors move in the same direction (high or low) so forecast errors in total tend to trace the same path as either the high or the low errors.


```{r ouehp, echo=FALSE, out.height="100%", out.width="90%"}
ouehp
```


## Individual meter response Expected vs Actual

The table below is fairly self-explanatory.  Points to note are as follows:

Expected and Actual figures are in kW.  Energy in kWh can be calculated by multiplying by (24 * number of days).

'Ref' and 'address' columns may be duplicated - this is simply that some clients use encoding and others do not for sites.
'mid' is our internal meter identification number, this is internationally unique (unlike MPR) and can be cited for support purposes.

Some meters may show a turndown of NaN - this stands for 'Not a Number' and will represent divide-by-zero errors and is typically due to corrupt data.

Some meters may show a high number of 'zeroes' - these are meters that have been reporting zero for a number of days. If longer than the reporting period it is likely that these are 'flatlining meters' - i.e. reporting zero despite real consumption - these should be checked with your AMR provider.

Otherwise the table is ranked in descending turndown order - i.e. priorities are at the top, and the potential for energy saving can be deduced from the expected and actual columns displayed.


```{r kable}
meter_events %>% arrange(desc(turndown)) %>% rename(zeroes = recent_zero) %>% 
  mutate(expected = round(expected), actual = round(actual)) %>% 
  DT::datatable(
      extensions = 'Buttons', options = list(
        dom = 'Bfrtip',
        buttons = c('copy', 'csv', 'excel'),
        lengthMenu = list(c(10,25,50,-1), c(10,25,50,"All")))
      )
```



## Further Support

This document has been prepared free of charge by kWIQly with a view to supporting clients during and following Covid-19. 

We believe that in addition to the distress & disruption individuals and businesses will be suffering, the energy manager has a tough time ahead, deciding how much to buy and on what basis, whether hedging is necessary, and whether further waves of infection will effect business etc. 

We hope to develop some scenario planning tools for our clients and to develop this specific solution further.

It might also report on arbitrary periods e.g. holidays in schools and universities etc, it might need forecasting and scenario planning support or perhaps it should be more interactive as an app (e.g. to show individual meter charts as in the example above).

Accordingly,

We hope this helps when help is most needed and we always welcome feedback regarding your needs and concerns,

Best wishes and stay safe,

the kWIQly team.


<script>
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip(); 
});
</script>


&nbsp;
<hr/>
<p style="text-align: center;">For support please contact George Catto</p>
<p style="text-align: center;"><span style="color: #808080;"><em>George@kWIQly.com</em></span></p>

<!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


<!-- Add font awesome icons -->
<p style="text-align: center;">
    <a href="https://www.linkedin.com/in/george-catto-6a0a4549/" class="fa fa-linkedin"></a>... Happy to connect on LinkedIn! 
</p>

&nbsp;


```{r exit}

poolClose(pool)

```
